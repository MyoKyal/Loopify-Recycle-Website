<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Return Wizard – Loopify Recycle</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { primary: '#1A5F3D', accent: '#F4A261' } } }
    };
  </script>

  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>
<body class="bg-light text-gray-900 min-h-screen">

  <!-- Progress Bar -->
  <div class="sticky top-0 z-50 bg-white shadow-sm">
    <div class="container mx-auto px-6 py-4 flex items-center justify-between">
      <a href="/" class="text-primary font-bold text-xl">Loopify</a>
      <div class="flex items-center space-x-2 text-sm">
        <span x-text="step>=1?'Check':'1'" :class="step>=1?'text-accent':'text-gray-400'"></span>
        <span class="text-gray-300">/</span>
        <span x-text="step>=2?'Check':'2'" :class="step>=2?'text-accent':'text-gray-400'"></span>
        <span class="text-gray-300">/</span>
        <span x-text="step>=3?'Check':'3'" :class="step>=3?'text-accent':'text-gray-400'"></span>
      </div>
    </div>
    <div class="h-1 bg-gray-200"><div class="h-full bg-accent transition-all" :style="`width:${(step/3)*100}%`"></div></div>
  </div>

  <div class="container mx-auto px-6 py-12 max-w-4xl" x-data="returnWizard()">
    <form @submit.prevent="submitReturn" class="space-y-12">

      <!-- STEP 1: Item Selection -->
      <section x-show="step === 1" x-transition>
        <h2 class="text-2xl md:text-3xl font-bold mb-8">What are you returning?</h2>

        <!-- Categories -->
        <div class="flex flex-wrap gap-2 mb-8">
          <template x-for="cat in categories" :key="cat.id">
            <button type="button" @click="selected.category = cat.id; selected.item = null; selected.condition = null"
                    :class="selected.category === cat.id ? 'bg-primary text-white' : 'bg-white text-gray-700 border'"
                    class="px-5 py-2 rounded-lg font-medium transition shadow-sm">
              <span x-text="cat.name"></span>
            </button>
          </template>
        </div>

        <!-- Items -->
        <div x-show="selected.category" class="grid md:grid-cols-3 gap-6">
          <template x-for="item in currentItems" :key="item.id">
            <label class="cursor-pointer block">
              <input type="radio" name="item" :value="item.id" x-model="selected.item" class="sr-only"/>
              <div class="p-5 border-2 rounded-xl transition"
                   :class="selected.item === item.id ? 'border-primary bg-primary/5' : 'border-gray-200 hover:border-primary/50'">
                <img :src="item.img" :alt="item.name" class="w-full h-32 object-contain mb-3"/>
                <p class="font-medium" x-text="item.name"></p>
                <p class="text-sm text-gray-600" x-text="item.reward"></p>
              </div>
            </label>
          </template>
        </div>

        <!-- Condition -->
        <div x-show="selected.item" class="mt-8">
          <p class="font-semibold mb-3">Condition</p>
          <div class="grid grid-cols-3 gap-3">
            <template x-for="cond in conditions" :key="cond.id">
              <label>
                <input type="radio" :value="cond.id" x-model="selected.condition" class="sr-only"/>
                <div class="p-3 text-center border rounded-lg cursor-pointer transition"
                     :class="selected.condition === cond.id ? 'border-primary bg-primary/10' : 'border-gray-300'">
                  <span x-text="cond.label"></span>
                </div>
              </label>
            </template>
          </div>
        </div>

        <div class="mt-10 flex justify-end">
          <button type="button" @click="nextStep()" :disabled="!canProceed(1)"
                  class="px-8 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 disabled:opacity-50">
            Next
          </button>
        </div>
      </section>

      <!-- STEP 2: Collection Method -->
      <section x-show="step === 2" x-transition>
        <h2 class="text-2xl md:text-3xl font-bold mb-8">How do you want to return it?</h2>

        <div class="grid md:grid-cols-2 gap-8">
          <label class="cursor-pointer">
            <input type="radio" name="method" value="dropoff" x-model="selected.method" class="sr-only"/>
            <div class="p-6 border-2 rounded-xl transition flex items-center space-x-4"
                 :class="selected.method === 'dropoff' ? 'border-primary bg-primary/5' : 'border-gray-200'">
              <div class="w-12 h-12 bg-accent/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h-4m-8 0H5"/></svg>
              </div>
              <div>
                <p class="font-semibold">Drop-off at Partner Shop</p>
                <p class="text-sm text-gray-600">Free. City Mart, Ocean, malls.</p>
              </div>
            </div>
          </label>

          <label class="cursor-pointer">
            <input type="radio" name="method" value="ship" x-model="selected.method" class="sr-only"/>
            <div class="p-6 border-2 rounded-xl transition flex items-center space-x-4"
                 :class="selected.method === 'ship' ? 'border-primary bg-primary/5' : 'border-gray-200'">
              <div class="w-12 h-12 bg-accent/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m-4-4l8 4 8-4"/></svg>
              </div>
              <div>
                <p class="font-semibold">Ship with Free Label</p>
                <p class="text-sm text-gray-600">We cover shipping.</p>
              </div>
            </div>
          </label>
        </div>

        <!-- Drop-off Map -->
        <div x-show="selected.method === 'dropoff'" class="mt-8">
          <div id="map" class="h-96 rounded-xl shadow-lg"></div>
          <p class="mt-4 text-sm text-gray-600 text-center" x-text="selected.dropoff ? selected.dropoff.name : 'Select a point'"></p>
        </div>

        <!-- Ship Address + Photo -->
        <div x-show="selected.method === 'ship'" class="mt-8 space-y-4">
          <input type="text" placeholder="Full Name" x-model="shipping.name" required class="w-full px-4 py-3 border rounded-lg"/>
          <input type="email" placeholder="Email/Phone" x-model="shipping.email" required class="w-full px-4 py-3 border rounded-lg"/>
          <input type="text" placeholder="Street" x-model="shipping.street" required class="w-full px-4 py-3 border rounded-lg"/>
          <div class="grid grid-cols-3 gap-3">
            <input type="text" placeholder="City" x-model="shipping.city" required class="col-span-2"/>
            <input type="text" placeholder="ZIP" x-model="shipping.zip" required/>
          </div>

          <!-- Photo Upload -->
          <div class="mt-6">
            <p class="font-semibold mb-2">Upload Photo (Optional)</p>
            <input type="file" accept="image/*" @change="onPhotoSelect" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-accent file:text-primary"/>
            <img title="." x-show="photoPreview" :src="photoPreview" class="mt-3 w-32 h-32 object-cover rounded-lg"/>
          </div>
        </div>

        <div class="mt-10 flex justify-between">
          <button type="button" @click="step--" class="px-6 py-3 text-gray-600">Back</button>
          <button type="button" @click="nextStep()" :disabled="!canProceed(2)"
                  class="px-8 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 disabled:opacity-50">
            Next
          </button>
        </div>
      </section>

      <!-- STEP 3: Review -->
      <section x-show="step === 3" x-transition>
        <h2 class="text-2xl md:text-3xl font-bold mb-8">Review & Get Reward</h2>
        <div class="bg-white p-6 rounded-xl shadow-sm space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-semibold text-lg mb-3">Item</h3>
              <div class="flex items-center space-x-3">
                <img title="." src="selectedItem.img" class="w-16 h-16 object-contain"/>
                <div>
                  <p x-text="selectedItem.name"></p>
                  <p class="text-sm text-gray-600" x-text="selectedCondition.label"></p>
                </div>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-lg mb-3">Method</h3>
              <p x-text="selected.method === 'dropoff' ? 'Drop-off at: ' + (selected.dropoff?.name || '') : 'Ship to Yangon Hub'"></p>
            </div>
          </div>
          <div class="border-t pt-6">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold">Reward</p>
                <p class="text-sm text-gray-600">KBZ Pay or Credit</p>
              </div>
              <p class="text-3xl font-bold text-accent" x-text="reward"></p>
            </div>
          </div>
        </div>

        <div class="mt-10 flex justify-between">
          <button type="button" @click="step--" class="px-6 py-3 text-gray-600">Back</button>
          <button type="submit" class="px-8 py-3 bg-accent text-primary font-bold rounded-lg hover:bg-accent/90 flex items-center">
            <span x-show="!submitting">Confirm & Get Label</span>
            <span x-show="submitting">Processing...</span>
          </button>
        </div>
      </section>

    </form>
  </div>

  <!-- Alpine Logic -->
  <script>
    function returnWizard() {
      return {
        step: 1,
        submitting: false,
        map: null,
        photo: null,
        photoPreview: null,

        categories: [
          { id: 'electronics', name: 'Electronics' },
          { id: 'clothing', name: 'Clothing' },
          { id: 'packaging', name: 'Packaging' }
        ],
        items: {
          electronics: [
            { id: 'phone', name: 'Smartphone', img: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=200', reward: '30,000–150,000 MMK' },
            { id: 'laptop', name: 'Laptop', img: 'https://images.unsplash.com/photo-1496181133206-80ce9b88a438?w=200', reward: '80,000–400,000 MMK' }
          ],
          clothing: [
            { id: 'jeans', name: 'Jeans', img: 'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?w=200', reward: '5,000–15,000 MMK' }
          ],
          packaging: [
            { id: 'cardboard', name: 'Cardboard', img: 'https://images.unsplash.com/photo-1581092583538-9d1dbbb9af37?w=200', reward: '500 MMK/kg' }
          ]
        },
        conditions: [
          { id: 'like-new', label: 'Like New' },
          { id: 'good', label: 'Good' },
          { id: 'worn', label: 'Worn' }
        ],

        selected: { category: null, item: null, condition: null, method: null, dropoff: null, rewardType: 'credit' },
        shipping: { name: '', email: '', street: '', city: '', zip: '', country: 'MM' },

        get currentItems() { return this.items[this.selected.category] || []; },
        get selectedItem() { return this.currentItems.find(i => i.id === this.selected.item) || {}; },
        get selectedCondition() { return this.conditions.find(c => c.id === this.selected.condition) || {}; },
        get reward() {
          const base = this.selectedItem.reward || '0 MMK';
          if (base.includes('kg')) return base;
          const factor = { 'like-new': 1, 'good': 0.7, 'worn': 0.4 }[this.selected.condition] || 1;
          const num = parseInt(base.match(/[\d,]+/)?.[0]?.replace(/,/g, '') || 0);
          return `${Math.round(num * factor)} MMK`;
        },
        get rewardAmount() { return this.reward.replace(' MMK', ''); },

        canProceed(s) {
          if (s === 1) return this.selected.category && this.selected.item && this.selected.condition;
          if (s === 2) {
            if (this.selected.method === 'dropoff') return this.selected.dropoff;
            if (this.selected.method === 'ship')
              return this.shipping.name && this.shipping.email && this.shipping.street && this.shipping.city && this.shipping.zip;
          }
          return false;
        },
        nextStep() { if (this.canProceed(this.step)) this.step++; },

        onPhotoSelect(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => { this.photo = ev.target.result; this.photoPreview = ev.target.result; };
          reader.readAsDataURL(file);
        },

        initMap() {
          if (this.map) return;
          this.map = L.map('map').setView([21.9162, 96.2832], 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
          const points = [
            { name: 'City Mart Yangon', lat: 16.8400, lng: 96.1700 },
            { name: 'Ocean Mandalay', lat: 21.9833, lng: 96.0833 }
          ];
          points.forEach(p => {
            L.marker([p.lat, p.lng]).addTo(this.map)
              .bindPopup(`<b>${p.name}</b><br><button class="text-accent underline" onclick="selectDropoff(${p.lat},${p.lng},'${p.name}')">Select</button>`);
          });
          window.selectDropoff = (lat, lng, name) => {
            this.selected.dropoff = { name, lat, lng };
            this.map.setView([lat, lng], 15);
          };
        },

        async submitReturn() {
          this.submitting = true;
          const payload = {
            selected: this.selected,
            shipping: this.shipping,
            rewardAmount: this.rewardAmount,
            photo: this.photo
          };
          try {
            const res = await fetch('/api/return', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('API error');
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'loopify-return-label.pdf'; a.click();
            alert('Label downloaded!');
            setTimeout(() => location.href = '/public/return/thanks.html', 1000);
          } catch (err) {
            alert('Error. Try again.');
            console.error(err);
          } finally {
            this.submitting = false;
          }
        },

        init() {
          this.$watch('selected.method', val => {
            if (val === 'dropoff') this.$nextTick(() => this.initMap());
          });
        }
      };
    }
  </script>
</body>
</html>